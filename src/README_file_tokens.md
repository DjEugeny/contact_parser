# Скрипт подсчёта токенов для CONTACT_PARSER

## Описание

Скрипт `file_tokens.py` предназначен для предварительной оценки объёма файлов и вложений, которые отправляются в LLM для анализа. Он подсчитывает количество символов и токенов в письмах и их вложениях, создавая детальный HTML-отчёт.

## Возможности

- **Интерактивное меню** выбора даты или всех дат сразу
- **Автоматический подсчёт** символов и токенов с помощью tiktoken
- **Обработка вложений** с поиском OCR-результатов
- **Кэширование** для пропуска уже обработанных файлов
- **Детальная отчётность** в HTML-формате с группировкой по датам
- **Логирование** всех операций

## Установка зависимостей

```bash
# Активируйте виртуальное окружение
source venv/bin/activate

# Установите зависимости
pip install -r requirements.txt
```

## Использование

### Запуск скрипта

```bash
cd /path/to/contact_parser
source venv/bin/activate
python src/file_tokens.py
```

### Интерактивное меню

При запуске появится меню с доступными датами:

```
==================================================
ДОСТУПНЫЕ ДАТЫ ДЛЯ ОБРАБОТКИ:
==================================================
 1. 2025-08-25
 2. 2025-08-22
 3. 2025-08-21
...
45. Все даты
46. Выход
==================================================

Выберите номер (или 'q' для выхода):
```

### Опции выбора

- **Конкретная дата** (1-44): Обработка писем за выбранную дату
- **Все даты** (45): Обработка всех доступных дат
- **Выход** (46): Завершение работы
- **'q'**: Быстрый выход

## Структура данных

### Входные данные

- **Письма**: `data/emails/<DATE>/<email_file.json>`
- **Вложения**: `data/attachments/<DATE>/<attachment_file>`
- **OCR-результаты**: `data/final_results/texts/<DATE>/<attachment_file.txt>`

### Выходные данные

- **Отчёты**: `data/file_tokens/report_file_tokens_<timestamp>.html`
- **Кэш**: `data/.processed_file_tokens.json`
- **Логи**: `file_tokens.log`

## Формат отчёта

HTML-таблица содержит:

| Колонка | Описание |
|---------|----------|
| Дата | Дата письма |
| Файл | Имя файла письма или вложения |
| Символы | Количество символов |
| Токены | Количество токенов |
| Сумма | Общая сумма символов + токенов |

### Типы строк

- **Обычные строки**: Письма и вложения
- **Строки с итого**: Итоги по каждой дате
- **Общий итого**: Общая сумма по всем датам

### Стилизация

- **Вложения**: Курсив, серый цвет
- **Ошибки**: Красный цвет
- **Информация**: Синий цвет
- **Итоги**: Голубой фон, жирный шрифт
- **Общий итого**: Жёлтый фон, увеличенный шрифт

## Логика работы

### 1. Выбор даты
- Сканирование папки `data/emails/`
- Сортировка дат по убыванию
- Отображение интерактивного меню

### 2. Обработка писем
- Чтение JSON-файлов писем
- Извлечение тела письма и списка вложений
- Подсчёт символов и токенов для тела письма

### 3. Обработка вложений
- Поиск OCR-результатов в `data/final_results/texts/`
- Подсчёт символов и токенов для обработанных вложений
- Отметка необработанных вложений

### 4. Кэширование
- Вычисление MD5-хэша каждого файла
- Сравнение с сохранёнными хэшами
- Пропуск неизменённых файлов

### 5. Генерация отчёта
- Создание HTML-таблицы
- Группировка по датам
- Подсчёт итогов и общего итого

## Алгоритм подсчёта токенов

```python
import tiktoken

# Инициализация энкодера
encoder = tiktoken.get_encoding("cl100k_base")

# Подсчёт токенов
tokens = len(encoder.encode(text))
```

## Обработка ошибок

- **Файлы не найдены**: Логирование предупреждений
- **Ошибки чтения**: Запись в отчёт с пометкой "Ошибка"
- **Проблемы с tiktoken**: Fallback на подсчёт только символов
- **Проблемы с кэшем**: Автоматическое восстановление

## Производительность

- **Кэширование**: Пропуск уже обработанных файлов
- **Пакетная обработка**: Обработка всех дат за один запуск
- **Логирование**: Отслеживание прогресса и проблем

## Примеры использования

### Обработка одной даты
```bash
echo "1" | python src/file_tokens.py
```

### Обработка всех дат
```bash
echo "45" | python src/file_tokens.py
```

### Автоматизация
```bash
# В скрипте
python src/file_tokens.py <<< "45"
```

## Логи

Скрипт создаёт два типа логов:

1. **Консольные логи**: Отображение прогресса в реальном времени
2. **Файловые логи**: `file_tokens.log` для анализа и отладки

### Уровни логирования

- **INFO**: Основные операции (обработка файлов, создание отчётов)
- **WARNING**: Незначительные проблемы (файлы не найдены)
- **ERROR**: Критические ошибки (проблемы с чтением, сохранением)

## Требования

- Python 3.11+
- tiktoken
- Стандартные библиотеки Python (json, os, pathlib, logging, hashlib)

## Структура проекта

```
src/
├── file_tokens.py          # Основной скрипт
└── README_file_tokens.md   # Документация

data/
├── emails/                 # JSON-файлы писем
├── attachments/            # Оригинальные вложения
├── final_results/texts/    # OCR-результаты
├── file_tokens/            # Генерируемые отчёты
└── .processed_file_tokens.json  # Кэш обработанных файлов
```

## Поддержка

При возникновении проблем:

1. Проверьте логи в `file_tokens.log`
2. Убедитесь, что все зависимости установлены
3. Проверьте права доступа к папкам данных
4. Убедитесь, что структура папок соответствует ожидаемой

## Разработка

Скрипт написан в соответствии с принципами:

- **Модульность**: Разделение на логические функции
- **Обработка ошибок**: Graceful handling исключений
- **Логирование**: Детальное отслеживание операций
- **Кэширование**: Оптимизация повторных запусков
- **Документирование**: Подробные комментарии и docstrings
