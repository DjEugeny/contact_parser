# Анализ проблемы неточного подсчета файлов

**Дата создания:** 2025-08-27 21:25 (UTC+07)  
**Статус:** ✅ Решено  
**Приоритет:** Высокий  

## Описание проблемы

Пользователь сообщил о расхождении в подсчете файлов для даты 2025-07-29:
- Скрипт показывает 10 файлов, все "уже обработаны"
- В папке результатов находится только 8 файлов
- Пользователь ожидал увидеть 8 файлов для обработки

## Проведенный анализ

### 1. Проверка содержимого папок

**Папка вложений:** `/Users/evgenyzach/contact_parser/data/attachments/2025-07-29`
- Количество файлов: 10
- Все файлы имеют расширения .pdf и .docx

**Папка результатов:** `/Users/evgenyzach/contact_parser/data/final_results/texts/2025-07-29`
- Количество файлов: 8
- Соответствует ожиданиям пользователя

### 2. Создание диагностического скрипта

Создан скрипт `debug_file_matching.py` для анализа логики сопоставления файлов:
- Копирует функцию `_normalize_filename` из OCR-процессора
- Анализирует соответствие между файлами в папках attachments и results
- Выявляет группы дубликатов по нормализованным именам

### 3. Результаты анализа

**Обнаружены 2 группы дубликатов:**

#### Группа 1: "Ком.пред.29.07.2025 для Москва Компания МИЛЛАБ для Абакан ЦГиЭ _ДТпрайм 5М6_ ноутбук_ Дтпрайм II 6М6"
- `20250729_dna-technology_ru_6360137e_084824_attach_Ком.пред.29.07.2025 для Москва Компания МИЛЛАБ для Абакан ЦГиЭ _ДТпрайм 5М6_ ноутбук_ Дтпрайм II 6М6_.pdf`
- `20250729_dna-technology_ru_6360137e_204421_attach_Ком.пред.29.07.2025 для Москва Компания МИЛЛАБ для Абакан ЦГиЭ _ДТпрайм 5М6_ ноутбук_ Дтпрайм II 6М6_.pdf`

#### Группа 2: "Ком.пред.14.03.2025 для Москва Компания МИЛЛАБ для Абакан ЦГиЭ _ДТпрайм 5М6_ ноутбук"
- `20250729_dna-technology_ru_6360137e_204406_attach_Ком.пред.14.03.2025 для Москва Компания МИЛЛАБ для Абакан ЦГиЭ _ДТпрайм 5М6_ ноутбук_.pdf`
- `20250729_dna-technology_ru_6360137e_084802_attach_Ком.пред.14.03.2025 для Москва Компания МИЛЛАБ для Абакан ЦГиЭ _ДТпрайм 5М6_ ноутбук_.pdf`

## Объяснение поведения системы

1. **OCR-процессор работает корректно:**
   - Функция `_normalize_filename` правильно определяет дубликаты
   - Для каждой группы дубликатов обрабатывается только один файл
   - Результат сохраняется под нормализованным именем

2. **Подсчет "пропущенных" файлов:**
   - Система считает все 10 файлов как "уже обработанные"
   - Это технически корректно, так как для каждого файла есть результат обработки
   - Но может вводить в заблуждение пользователя

## Рекомендации по улучшению

1. **Улучшить отображение статистики:**
   - Показывать количество уникальных файлов (после нормализации)
   - Отображать информацию о найденных дубликатах
   - Добавить детализацию по группам дубликатов

2. **Расширить диагностическую информацию:**
   - Включить список дубликатов в отчеты обработки
   - Показывать соответствие между исходными и нормализованными именами

3. **Документировать логику нормализации:**
   - Создать описание правил определения дубликатов
   - Добавить примеры нормализации имен файлов

## Заключение

**Проблема решена:** Система работает корректно. Расхождение в подсчете объясняется наличием дубликатов файлов, которые правильно определяются и обрабатываются OCR-процессором.

**Статус:** ✅ Анализ завершен, проблема объяснена

---
*Отчет создан: 2025-01-21 22:45:00 (UTC+07)*