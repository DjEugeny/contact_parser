# 📊 Анализ архитектуры проекта Contact Parser

**Дата создания:** 2025-08-24 11:03 (UTC+07)  
**Версия:** 1.0  
**Статус:** Полный анализ архитектуры и потока данных

---

## 🎯 Обзор проекта

**Contact Parser** — это комплексная система для автоматизированного извлечения контактной информации из email-писем и их вложений с использованием технологий OCR и LLM.

### Основные возможности:
1. 📧 Загрузка писем с IMAP-серверов
2. 📎 Обработка вложений (PDF, DOC, DOCX, XLS, XLSX, изображения)
3. 🔍 OCR-распознавание текста из изображений (Google Cloud Vision)
4. 🤖 Извлечение контактов с помощью LLM (OpenRouter, Groq, Replicate)
5. 📊 Экспорт результатов в Google Sheets
6. 📈 Детальная статистика и отчетность

---

## 🏗️ Архитектура системы

### Основные компоненты:

```
┌─────────────────────────────────────────────────────────────┐
│                    CONTACT PARSER SYSTEM                    │
├─────────────────────────────────────────────────────────────┤
│  📧 Email Fetching  │  🔍 OCR Processing  │  🤖 LLM Analysis │
│  ┌─────────────────┐ │ ┌─────────────────┐ │ ┌──────────────┐ │
│  │ advanced_email_ │ │ │ ocr_processor.py│ │ │ llm_extractor│ │
│  │ fetcher.py      │ │ │                 │ │ │ .py          │ │
│  └─────────────────┘ │ └─────────────────┘ │ └──────────────┘ │
├─────────────────────────────────────────────────────────────┤
│  📊 Data Integration & Export                               │
│  ┌─────────────────┐ ┌─────────────────┐ ┌──────────────┐   │
│  │ integrated_llm_ │ │ google_sheets_  │ │ google_sheets│   │
│  │ processor.py    │ │ bridge.py       │ │ _exporter.py │   │
│  └─────────────────┘ └─────────────────┘ └──────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

---

## 🔄 Поток данных

### 1. Точка входа: `google_sheets_exporter.py`

**Роль:** Главный модуль-оркестратор системы

**Функции:**
- 🎛️ Интерактивное меню для пользователя
- 📅 Выбор дат для обработки
- 🔧 Настройка параметров обработки
- 📊 Экспорт результатов в Google Sheets
- 📈 Отображение статистики

**Активируемые модули:**
1. `google_sheets_bridge.py` → для интеграции с LLM-процессором
2. `integrated_llm_processor.py` → для обработки писем

---

### 2. Интеграционный слой: `google_sheets_bridge.py`

**Роль:** Мост между обработкой данных и экспортом

**Функции:**
- 🔄 Координация между LLM-процессором и экспортером
- 📧 Автоматическая загрузка писем при их отсутствии
- 🛡️ Обработка ошибок и fallback-сценарии
- 📊 Локальный экспорт как резервный вариант

**Активируемые модули:**
1. `advanced_email_fetcher.py` → при отсутствии писем
2. `integrated_llm_processor.py` → для обработки
3. `google_sheets_exporter.py` → для экспорта

---

### 3. Центральный процессор: `integrated_llm_processor.py`

**Роль:** Основной модуль обработки писем и извлечения контактов

**Функции:**
- 📧 Загрузка обработанных писем
- 📎 Обработка вложений через OCR
- 🤖 Извлечение контактов через LLM
- 📊 Сбор статистики обработки
- 💾 Сохранение результатов в JSON

**Активируемые модули:**
1. `email_loader.py` → загрузка писем
2. `ocr_processor.py` → обработка вложений
3. `llm_extractor.py` → извлечение контактов

---

### 4. Загрузчик писем: `email_loader.py`

**Роль:** Загрузка и фильтрация обработанных писем

**Функции:**
- 📁 Сканирование папок с письмами
- 📧 Загрузка JSON-файлов писем
- 📎 Фильтрация писем с вложениями
- 🔍 Проверка статуса вложений

**Источники данных:**
- `data/emails/YYYY-MM-DD/email_*.json`
- `data/attachments/YYYY-MM-DD/`

---

### 5. Загрузчик писем с сервера: `advanced_email_fetcher.py`

**Роль:** Первичная загрузка писем с IMAP-сервера

**Функции:**
- 🌐 Подключение к IMAP-серверу
- 📧 Загрузка писем за указанный период
- 📎 Скачивание и сохранение вложений
- 🚫 Фильтрация спама и нежелательных писем
- 💾 Сохранение в структурированном формате

**Выходные данные:**
- `data/emails/YYYY-MM-DD/email_*.json`
- `data/attachments/YYYY-MM-DD/`

---

### 6. OCR-процессор: `ocr_processor.py`

**Роль:** Извлечение текста из документов и изображений

**Функции:**
- 🖼️ OCR изображений через Google Cloud Vision
- 📄 Извлечение текста из PDF
- 📝 Обработка DOC/DOCX документов
- 📊 Чтение Excel файлов (XLS/XLSX)
- 💾 Сохранение результатов OCR

**Поддерживаемые форматы:**
- Изображения: PNG, JPG, JPEG, TIFF, BMP, WEBP
- Документы: PDF, DOC, DOCX, TXT
- Таблицы: XLS, XLSX

---

### 7. LLM-экстрактор: `llm_extractor.py`

**Роль:** Извлечение контактной информации с помощью LLM

**Функции:**
- 🤖 Интеграция с LLM-провайдерами (OpenRouter, Groq, Replicate)
- 📝 Обработка промптов для извлечения контактов
- 🔄 Система fallback между провайдерами
- ⚡ Rate limiting и управление нагрузкой
- 📊 Парсинг JSON-ответов от LLM

**LLM-провайдеры:**
- OpenRouter (основной)
- Groq (резервный)
- Replicate (резервный)

---

## 📁 Структура данных

### Входные данные:
```
data/
├── emails/
│   └── YYYY-MM-DD/
│       ├── email_001.json
│       ├── email_002.json
│       └── ...
└── attachments/
    └── YYYY-MM-DD/
        ├── thread_001/
        │   ├── document.pdf
        │   └── image.png
        └── thread_002/
            └── spreadsheet.xlsx
```

### Промежуточные данные:
```
data/final_results/
├── texts/
│   └── YYYY-MM-DD/
│       ├── ocr_results_001.json
│       └── ocr_results_002.json
└── reports/
    └── YYYY-MM-DD/
        └── ocr_summary.json
```

### Выходные данные:
```
data/final_results/
└── llm_analysis/
    └── YYYY-MM-DD/
        ├── analysis_results.json
        ├── contacts_extracted.json
        └── processing_stats.json
```

---

## 🔧 Конфигурация и настройки

### Переменные окружения (.env):
```
# IMAP настройки
IMAP_SERVER=imap.gmail.com
IMAP_PORT=993
IMAP_USER=your-email@gmail.com
IMAP_PASSWORD=your-app-password

# Google Sheets
GOOGLE_SPREADSHEET_ID=your-spreadsheet-id

# LLM провайдеры
OPENROUTER_API_KEY=your-openrouter-key
GROQ_API_KEY=your-groq-key
REPLICATE_API_TOKEN=your-replicate-token

# Google Cloud Vision
GOOGLE_APPLICATION_CREDENTIALS=path/to/service-account.json
```

### Ключевые файлы конфигурации:
- `service_account.json` → Google Sheets API
- `prompts/contact_extraction.txt` → Промпт для LLM
- `config/filters/` → Фильтры для писем

---

## 🚀 Сценарии запуска

### 1. Полный цикл обработки:
```bash
python src/google_sheets_exporter.py
# → Интерактивное меню
# → Выбор даты
# → Автоматическая обработка
# → Экспорт в Google Sheets
```

### 2. Только загрузка писем:
```bash
python src/advanced_email_fetcher.py --date 2025-01-24
```

### 3. Только OCR обработка:
```bash
python src/ocr_processor.py
```

### 4. Только LLM анализ:
```bash
python src/integrated_llm_processor.py
```

---

## 📊 Метрики и мониторинг

### Собираемая статистика:
- 📧 Количество обработанных писем
- 📎 Количество обработанных вложений
- 🔍 Успешность OCR распознавания
- 🤖 Успешность LLM извлечения
- ⏱️ Время обработки
- 💰 Стоимость LLM запросов

### Логирование:
- 📝 Детальные логи в `data/logs/`
- 🚨 Обработка ошибок и исключений
- 📊 Статистика по провайдерам

---

## 🛡️ Обработка ошибок

### Механизмы устойчивости:
- 🔄 Retry логика для API запросов
- 🔀 Fallback между LLM провайдерами
- 💾 Сохранение промежуточных результатов
- 🚫 Graceful degradation при ошибках

### Типы ошибок:
- 🌐 Сетевые ошибки (IMAP, API)
- 📄 Ошибки обработки файлов
- 🤖 Ошибки LLM провайдеров
- 📊 Ошибки экспорта в Google Sheets

---

## 🔮 Возможности расширения

### Потенциальные улучшения:
- 🔄 Асинхронная обработка
- 📊 Веб-интерфейс для мониторинга
- 🤖 Дополнительные LLM провайдеры
- 📱 Мобильные уведомления
- 🔍 Расширенная аналитика

---

**Конец отчета**