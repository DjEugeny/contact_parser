# –û—Ç—á–µ—Ç: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å Rate Limit –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π JSON Schema

## –û–±–∑–æ—Ä –ø—Ä–æ–±–ª–µ–º

### 1. Rate Limit —É Groq (HTTP 429)
- **–ü—Ä–æ–±–ª–µ–º–∞**: –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API Groq –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –æ—à–∏–±–∫–∞–º HTTP 429
- **–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è**: –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö, –ø–æ—Ç–µ—Ä—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- **–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å**: –í—ã—Å–æ–∫–∞—è

### 2. –ü—Ä–æ–±–ª–µ–º—ã —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π JSON Schema
- **–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤ LLM –ø—Ä–∏–≤–æ–¥–∏–ª–∞ –∫ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º –¥–∞–Ω–Ω—ã–º
- **–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è**: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤, –æ—à–∏–±–∫–∏ —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö
- **–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å**: –í—ã—Å–æ–∫–∞—è

## –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

### 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ Rate Limit (HTTP 429)

#### –î–æ–±–∞–≤–ª–µ–Ω–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤ `_make_llm_request`:
```python
# –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ rate limit
if response.status_code == 429:
    self.provider_errors[current_provider] += 1
    retry_after = response.headers.get('Retry-After', '60')
    try:
        wait_time = int(retry_after)
    except ValueError:
        wait_time = 60
    
    raise Exception(f"Rate limit exceeded. Retry after {wait_time} seconds")
```

#### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω exponential backoff –≤ `_make_llm_request_with_retries`:
```python
if "Rate limit exceeded" in str(e):
    # –ò–∑–≤–ª–µ–∫–∞–µ–º –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ
    import re
    match = re.search(r'Retry after (\d+) seconds', str(e))
    if match:
        base_wait = int(match.group(1))
    else:
        base_wait = 60
    
    # Exponential backoff —Å –º–∞–∫—Å–∏–º—É–º–æ–º 300 —Å–µ–∫—É–Ω–¥
    wait_time = min(base_wait * (2 ** attempt), 300)
    print(f"‚è≥ Rate limit: –æ–∂–∏–¥–∞–Ω–∏–µ {wait_time} —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–æ–º...")
    time.sleep(wait_time)
    continue
```

### 2. –£–ª—É—á—à–µ–Ω–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è JSON Schema

#### –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ –¥–µ—Ç–∞–ª—å–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤:
```python
def _validate_contact_fields(self, contact: dict, index: int) -> bool:
    """üîç –î–µ—Ç–∞–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–ª–µ–π –∫–æ–Ω—Ç–∞–∫—Ç–∞"""
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è email
    email = contact.get('email', '')
    if email and not self._is_valid_email(email):
        print(f"‚ö†Ô∏è –ö–æ–Ω—Ç–∞–∫—Ç {index}: –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email '{email}'")
        contact['email'] = ''  # –û—á–∏—â–∞–µ–º –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    phone = contact.get('phone', '')
    if phone and not self._is_valid_phone(phone):
        print(f"‚ö†Ô∏è –ö–æ–Ω—Ç–∞–∫—Ç {index}: –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω '{phone}'")
        contact['phone'] = ''  # –û—á–∏—â–∞–µ–º –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è confidence (0-1)
    confidence = contact.get('confidence', 0)
    if not isinstance(confidence, (int, float)):
        contact['confidence'] = 0.0
    elif confidence < 0 or confidence > 1:
        contact['confidence'] = max(0, min(1, float(confidence)))
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–µ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    has_name = contact.get('name', '').strip()
    has_email = contact.get('email', '').strip()
    has_phone = contact.get('phone', '').strip()
    
    return bool(has_name or has_email or has_phone)
```

#### –î–æ–±–∞–≤–ª–µ–Ω—ã –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏:
- `_is_valid_email()`: –ü—Ä–æ–≤–µ—Ä–∫–∞ email –ø–æ regex –ø–∞—Ç—Ç–µ—Ä–Ω—É
- `_is_valid_phone()`: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (7-15 —Ü–∏—Ñ—Ä, –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç)

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω–∏–π
- **–û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª**: `src/llm_extractor.py`
- **–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –º–µ—Ç–æ–¥—ã**:
  - `_make_llm_request` (—Å—Ç—Ä–æ–∫–∏ ~195-220)
  - `_make_llm_request_with_retries` (—Å—Ç—Ä–æ–∫–∏ ~225-280)
  - `_validate_json_schema` (—Å—Ç—Ä–æ–∫–∏ ~120-165)
  - –ù–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã: `_validate_contact_fields`, `_is_valid_email`, `_is_valid_phone`

### –ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ rate limit**:
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –æ–∂–∏–¥–∞–Ω–∏—è –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
   - Exponential backoff —Å —Ä–∞–∑—É–º–Ω—ã–º–∏ –ª–∏–º–∏—Ç–∞–º–∏
   - –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º–∏ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–æ–≤

2. **–ö–∞—á–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö**:
   - –°—Ç—Ä–æ–≥–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è email –∏ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ —Å —á–∞—Å—Ç–∏—á–Ω–æ –≤–∞–ª–∏–¥–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ –∏ –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ –∑–Ω–∞—á–µ–Ω–∏–π

3. **–û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å**:
   - Graceful degradation –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –≤–∞–ª–∏–¥–∞—Ü–∏–∏
   - –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º
   - –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–∏ —á–∞—Å—Ç–∏—á–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

‚úÖ **–ü—Ä–æ–±–ª–µ–º–∞ rate limit —Ä–µ—à–µ–Ω–∞**: –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ HTTP 429 —Å exponential backoff  
‚úÖ **–í–∞–ª–∏–¥–∞—Ü–∏—è JSON —É–ª—É—á—à–µ–Ω–∞**: –î–µ—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –ø–æ–ª–µ–π –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤  
‚úÖ **–ö–∞—á–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö –ø–æ–≤—ã—à–µ–Ω–æ**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π  
‚úÖ **–£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã**: Graceful handling –æ—à–∏–±–æ–∫ –±–µ–∑ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏  

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å:
1. –û–±—Ä–∞–±–æ—Ç–∫—É rate limit –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ
2. –í–∞–ª–∏–¥–∞—Ü–∏—é —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ email –∏ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤
3. –ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ —á–∞—Å—Ç–∏—á–Ω–æ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ—Ç LLM
4. –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º–∏ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è**: 2025-08-24 11:45:00 (UTC+07)  
**–°—Ç–∞—Ç—É—Å**: –ó–∞–≤–µ—Ä—à–µ–Ω–æ  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: –í—ã—Å–æ–∫–∏–π