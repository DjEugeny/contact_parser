# Отчет: Рефакторинг конфигурации LLM-провайдеров

## Дата и время
2025-01-25 19:45 (UTC+07)

## Цель работы
Удаление хардкодированных настроек LLM-провайдеров и переход на динамическую конфигурацию из `providers.json` для повышения гибкости и устойчивости системы.

## Выполненные задачи

### 1. Удаление хардкода из llm_extractor.py
- **Файл**: `src/llm_extractor.py`
- **Изменения**:
  - Обновлен метод `_log_provider_status` для использования динамических имен провайдеров из `self.config.provider_order`
  - Добавлена проверка наличия провайдера в `self.provider_states` перед доступом к его состоянию
  - Удалены все хардкодированные упоминания конкретных провайдеров

### 2. Обновление config.py для динамической загрузки
- **Файл**: `src/config.py`
- **Изменения**:
  - Добавлена динамическая загрузка конфигурации провайдеров из `config/providers.json`
  - Реализована поддержка всех провайдеров, указанных в конфигурации
  - Добавлена поддержка нового провайдера `replicate`
  - Внедрены динамические приоритеты и настройки повторных попыток для каждого провайдера
  - Обновлен метод `validate_api_keys` для проверки `REPLICATE_API_KEY`

### 3. Поддержка трех провайдеров
Система теперь поддерживает три провайдера с различными характеристиками:

1. **OpenRouter**:
   - Бесплатные модели с ограничением по количеству запросов в день
   - Используется как основной провайдер для тестов

2. **Groq**:
   - Резервный провайдер для fallback системы
   - Быстрая обработка запросов

3. **Replicate**:
   - Платные модели с балансом и деньгами
   - На этапе тестирования выбора оптимальной модели

## Технические детали

### Структура providers.json
```json
{
  "provider_order": ["openrouter", "groq", "replicate"],
  "provider_settings": {
    "openrouter": {
      "priority": 1,
      "max_failures_before_skip": 3,
      "retry_delay_seconds": 2
    },
    "groq": {
      "priority": 2,
      "max_failures_before_skip": 2,
      "retry_delay_seconds": 1
    },
    "replicate": {
      "priority": 3,
      "max_failures_before_skip": 5,
      "retry_delay_seconds": 3
    }
  }
}
```

### Преимущества новой системы
1. **Гибкость**: Легко добавлять новых провайдеров без изменения кода
2. **Управляемость**: Все настройки в одном месте - `providers.json`
3. **Масштабируемость**: Поддержка любого количества провайдеров
4. **Устойчивость**: Динамическое управление приоритетами и fallback

## Проверка работоспособности
- Все провайдеры корректно инициализируются из конфигурации
- Система корректно обрабатывает приоритеты провайдеров
- Fallback механизм работает согласно настройкам

## Следующие шаги
1. Провести тестирование стабильности работы с новой конфигурацией
2. Оптимизировать параметры retry и timeout для каждого провайдера
3. Добавить мониторинг использования лимитов провайдеров

---
Отчет создан: 2025-01-25 19:45 (UTC+07)