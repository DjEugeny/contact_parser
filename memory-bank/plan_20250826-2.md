# План по исправлению проблем с Replicate провайдером

## Этап 1: Анализ и диагностика проблем

**Шаг 1:** 2025-08-26 14:00 (UTC+07) — Анализ логов терминала и выявление основных ошибок
- Проблемы с обработкой больших текстов (16665 символов)
- Зависание системы при обработке третьего письма
- Ошибки парсинга JSON ответов от Replicate
- Таймауты и проблемы с соединением
- В модуле llm_extractor.py временно отключить других провайдеров, кроме Replicate, необходимо настроить только его.

**Шаг 2:** 2025-08-26 14:15 (UTC+07) — Проверка текущего состояния Replicate провайдера
- Анализ методов _make_llm_request и _parse_llm_response в llm_extractor.py
- Проверка логики retry и fallback
- Анализ обработки больших промптов

## Этап 2: Исправление обработки больших текстов

**Шаг 1:** 2025-08-26 14:30 (UTC+07) — Реализация разбивки больших текстов
- Добавить проверку размера текста перед отправкой в LLM
- Реализовать chunking для текстов больше 10000 символов
- Добавить логику объединения результатов из частей

**Шаг 2:** 2025-08-26 15:00 (UTC+07) — Оптимизация промптов
- Сократить системные промпты для экономии токенов
- Добавить инструкции для обработки частичных текстов
- Улучшить структуру JSON схемы для ответов

## Этап 3: Улучшение retry логики и таймаутов

**Шаг 1:** 2025-08-26 12:30 (UTC+07) — Настройка таймаутов для Replicate
- Увеличить timeout для больших текстов (до 300 секунд)
- Добавить прогрессивные таймауты в зависимости от размера текста
- Реализовать graceful timeout handling

**Шаг 2:** 2025-08-26 16:00 (UTC+07) — Улучшение retry механизма
- Добавить экспоненциальный backoff для Replicate
- Реализовать специальную обработку для разных типов ошибок
- Добавить максимальное количество попыток для больших текстов

## Этап 4: Исправление парсинга JSON

**Шаг 1:** 2025-08-26 16:30 (UTC+07) — Улучшение парсинга ответов Replicate
- Добавить более надежную очистку JSON из ответа
- Реализовать fallback парсинг для частично поврежденных JSON
- Добавить валидацию структуры ответа перед парсингом

**Шаг 2:** 2025-08-26 17:00 (UTC+07) — Обработка edge cases
- Добавить обработку пустых ответов от Replicate
- Реализовать fallback для случаев когда JSON не найден
- Добавить логирование всех промежуточных состояний

## Этап 5: Улучшение логирования и диагностики

**Шаг 1:** 2025-08-26 17:30 (UTC+07) — Расширенное логирование
- Добавить детальное логирование всех запросов к Replicate
- Логировать размеры текстов и время обработки
- Добавить трассировку ошибок с контекстом

**Шаг 2:** 2025-08-26 18:00 (UTC+07) — Мониторинг производительности
- Добавить метрики времени обработки
- Реализовать предупреждения о больших текстах
- Добавить статистику успешности по размерам текста

## Этап 6: Тестирование и валидация

**Шаг 1:** 2025-08-26 18:30 (UTC+07) — Тестирование с реальными данными
- Протестировать обработку писем разного размера
- Проверить работу с письмами содержащими 16000+ символов
- Валидировать корректность извлечения контактов

**Шаг 2:** 2025-08-26 18:00 (UTC+07) — Интеграционное тестирование
- Протестировать полный pipeline google_sheets_exporter.py
- Проверить взаимодействие с google_sheets_bridge.py
- Валидировать fallback на другие провайдеры при необходимости

## Этап 7: Финализация и документация

**Шаг 1:** 2025-08-26 18:30 (UTC+07) — Оптимизация конфигурации
- Настроить оптимальные параметры для Replicate
- Обновить конфигурационные файлы
- Добавить рекомендации по использованию

**Шаг 2:** 2025-08-26 19:00 (UTC+07) — Создание отчета
- Документировать все исправления
- Создать руководство по диагностике проблем
- Обновить progress.md и tasks.md

## Ожидаемые результаты

- ✅ Стабильная работа с текстами любого размера
- ✅ Отсутствие зависаний при обработке больших писем
- ✅ Надежное извлечение контактов из всех типов писем
- ✅ Корректная обработка ошибок и fallback
- ✅ Детальное логирование для диагностики

## Временные рамки

**Общее время:** 6 часов  
**Приоритет:** Высокий  
**Зависимости:** Доступ к Replicate API

---
*План создан: 2025-08-26 11:00:00 (UTC+07)*